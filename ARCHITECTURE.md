# Heartbeat V2 架构设计文档

## 设计目标

1. **模块化**: 功能解耦，易于扩展
2. **可维护性**: 清晰的代码结构，易于理解和修改
3. **可靠性**: 模块隔离，单点故障不影响整体
4. **灵活性**: 配置驱动，支持动态调整
5. **可扩展性**: 插件式架构，添加新功能无需修改核心

## 核心设计模式

### 1. 插件架构模式 (Plugin Architecture)

**目的**: 支持功能的动态加载和扩展

**实现**:
- 核心框架提供基础设施（配置、日志、通知）
- 功能模块作为插件独立实现
- 通过统一接口与核心交互

**优势**:
- 新功能只需添加新模块
- 模块可独立开发和测试
- 核心代码保持稳定

### 2. 模板方法模式 (Template Method)

**目的**: 定义模块的标准生命周期

**实现**:
- `HeartbeatModule` 基类定义生命周期方法
- 子类实现 `execute()` 方法
- 基类处理通用逻辑（定时器、日志）

**优势**:
- 统一的模块行为
- 减少重复代码
- 易于理解和使用

### 3. 观察者模式 (Observer Pattern)

**目的**: 实现模块间的松耦合通信

**实现**:
- 核心继承 `EventEmitter`
- 模块通过 `emit()` 触发事件
- 其他模块通过 `on()` 监听事件

**优势**:
- 模块间解耦
- 灵活的通信机制
- 易于扩展新的交互

### 4. 外观模式 (Facade Pattern)

**目的**: 简化模块与核心的交互

**实现**:
- 核心提供统一的接口（notify, log, emit）
- 模块无需关心底层实现细节

**优势**:
- 简化模块开发
- 隐藏复杂性
- 易于维护和升级

## 架构层次

```
┌─────────────────────────────────────────┐
│           Application Layer             │
│         (index.js - 主入口)             │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│            Core Layer                   │
│      (heartbeat-core.js)                │
│  - 配置管理                             │
│  - 模块管理                             │
│  - 通知接口                             │
│  - 事件系统                             │
│  - 日志系统                             │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│         Module Interface Layer          │
│      (module-interface.js)              │
│  - 生命周期定义                         │
│  - 通用功能封装                         │
└─────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────┐
│          Module Layer                   │
│  - activity-monitor.js                  │
│  - error-alert.js                       │
│  - session-tracker.js                   │
│  - remote-control.js                    │
│  - work-stats.js                        │
└─────────────────────────────────────────┘
```

## 数据流

### 1. 启动流程

```
index.js
  → 创建 HeartbeatCore 实例
  → core.init()
    → loadConfig() - 加载配置
    → initLogger() - 初始化日志
    → loadModules() - 加载所有模块
      → 遍历 modules/ 目录
      → 创建模块实例
      → module.init()
  → core.start()
    → 遍历所有模块
    → module.start()
      → 立即执行一次 execute()
      → 设置定时器
```

### 2. 模块执行流程

```
定时器触发
  → module.execute()
    → 执行业务逻辑
    → this.notify() - 发送通知
      → core.notify()
        → 调用 Telegram API
    → this.log() - 记录日志
      → core.log()
        → 写入日志文件
    → this.emit() - 触发事件
      → core.emit()
        → 通知所有监听器
```

### 3. 事件通信流程

```
模块 A
  → this.emit('event:name', data)
    → core.emit('event:name', data)
      → EventEmitter 分发事件

模块 B
  → this.on('event:name', handler)
    → core.on('event:name', handler)
      → 接收事件并处理
```

## 关键设计决策

### 1. 为什么使用 EventEmitter？

**决策**: 核心继承 Node.js 的 EventEmitter

**理由**:
- 成熟稳定的事件系统
- 无需额外依赖
- 性能优秀
- 开发者熟悉

### 2. 为什么使用配置文件而不是环境变量？

**决策**: 使用 JSON 配置文件

**理由**:
- 支持复杂的嵌套配置
- 易于版本控制
- 可以动态重载（未来扩展）
- 更直观易读

### 3. 为什么每个模块独立定时器？

**决策**: 每个模块有自己的定时器

**理由**:
- 模块间完全隔离
- 可以独立配置间隔
- 一个模块崩溃不影响其他
- 更灵活的调度策略

### 4. 为什么使用类而不是函数？

**决策**: 使用 ES6 类定义模块

**理由**:
- 清晰的继承关系
- 封装性更好
- 易于理解和维护
- 支持私有方法（未来）

## 扩展点

### 1. 新增通知渠道

当前只支持 Telegram，未来可以扩展：

```javascript
// 在 core 中添加新方法
async notifyEmail(message) { ... }
async notifySlack(message) { ... }

// 模块中使用
await this.core.notifyEmail('Alert!');
```

### 2. 新增配置源

当前从 JSON 文件读取，未来可以支持：
- 环境变量
- 远程配置中心
- 数据库

### 3. 新增日志后端

当前写入文件，未来可以支持：
- 远程日志服务
- 数据库
- 云存储

### 4. 模块热重载

未来可以支持不重启系统更新模块：

```javascript
core.reloadModule('activity-monitor');
```

## 性能考虑

### 1. 内存管理

- 使用流式处理大文件
- 及时清理定时器
- 避免内存泄漏

### 2. 并发控制

- 模块并行执行
- 避免阻塞主线程
- 使用 async/await

### 3. 错误隔离

- try-catch 包裹模块执行
- 错误不传播到核心
- 记录错误日志

## 安全考虑

### 1. 配置文件安全

- 不提交敏感信息到版本控制
- 使用 .gitignore 排除 config.json
- 提供 config.example.json 模板

### 2. 模块沙箱

- 模块无法访问其他模块的私有数据
- 只能通过事件系统通信
- 核心控制所有敏感操作

### 3. 输入验证

- 验证配置文件格式
- 检查模块接口实现
- 防止注入攻击

## 测试策略

### 1. 单元测试

- 测试核心功能
- 测试模块接口
- 测试工具函数

### 2. 集成测试

- 测试模块加载
- 测试事件通信
- 测试通知发送

### 3. 端到端测试

- 测试完整启动流程
- 测试模块执行
- 测试错误处理

## 未来改进

### 1. 配置热重载

支持不重启系统更新配置

### 2. Web 管理界面

提供 Web UI 管理模块和查看日志

### 3. 模块市场

支持从远程仓库安装模块

### 4. 性能监控

监控模块执行时间和资源使用

### 5. 分布式支持

支持多实例协同工作

## 总结

Heartbeat V2 采用模块化、事件驱动的架构设计，具有良好的可扩展性和可维护性。通过清晰的分层和统一的接口，使得添加新功能变得简单直接。核心框架保持稳定，功能通过插件式模块扩展，是一个可持续发展的架构设计。

